<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>INFINITY ORBIT v4 — Draggable Space</title>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Rajdhani:wght@300;400;500;600;700&family=Orbitron:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        /* --- CORE STYLES --- */
        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; }
        :root {
            --nolan-gold: #c9a227;
            --nolan-orange: #d4740c;
            --orbit-25: #4ecdc4;
            --orbit-50: #ffe66d;
            --orbit-75: #ff6b6b;
            --orbit-infinity: #a855f7;
            --panel-bg: rgba(10, 22, 40, 0.9);
            --process-pos: #4ecdc4;
            --process-neg: #ff6b6b;
        }

        body {
            min-height: 100vh; background: #000; font-family: 'Rajdhani', sans-serif;
            overflow: hidden; color: #fff; /* Overflow hidden for dragging safety */
        }

        /* --- BACKGROUND FX --- */
        .space-bg {
            position: fixed; inset: 0;
            background: radial-gradient(circle at 50% 50%, #1a2030 0%, #000 100%);
            z-index: 0;
        }
        .stars { position: fixed; inset: 0; pointer-events: none; z-index: 1; }
        .star { position: absolute; background: white; border-radius: 50%; opacity: 0.6; }

        /* --- LAYOUT --- */
        .app-container { position: relative; z-index: 10; height: 100vh; padding: 20px; display: flex; flex-direction: column; }
        
        .header { text-align: center; height: 60px; }
        .title {
            font-family: 'Bebas Neue', sans-serif; font-size: 2.5rem; letter-spacing: 8px;
            background: linear-gradient(135deg, #fff 0%, var(--nolan-gold) 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }

        .dashboard {
            display: grid; grid-template-columns: 350px 1fr 300px; gap: 20px;
            height: calc(100vh - 100px); width: 100%;
        }
        @media (max-width: 1100px) { .dashboard { grid-template-columns: 1fr; } }

        /* --- PANELS --- */
        .panel { 
            background: var(--panel-bg); border: 1px solid rgba(255, 255, 255, 0.1); 
            border-radius: 6px; display: flex; flex-direction: column; backdrop-filter: blur(10px);
            transition: border-color 0.3s; overflow: hidden;
        }
        .panel.editing { border-color: var(--nolan-orange); box-shadow: 0 0 20px rgba(212, 116, 12, 0.2); }
        
        .panel-header {
            padding: 15px; border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex; align-items: center; gap: 10px; background: rgba(0,0,0,0.2);
        }
        .panel-dot { width: 6px; height: 6px; background: var(--nolan-gold); border-radius: 50%; }
        .panel-title { font-family: 'Orbitron'; font-size: 0.7rem; color: var(--nolan-gold); letter-spacing: 2px; }
        .panel-body { padding: 20px; flex: 1; display: flex; flex-direction: column; overflow-y: auto; }

        /* --- FORM ELEMENTS --- */
        .form-group { margin-bottom: 15px; }
        .form-label { display: block; font-family: 'Orbitron'; font-size: 0.5rem; color: rgba(255,255,255,0.5); margin-bottom: 5px; }
        .form-input {
            width: 100%; padding: 10px; background: rgba(0,0,0,0.4);
            border: 1px solid rgba(255,255,255,0.1); border-radius: 4px;
            color: white; font-family: 'Rajdhani'; font-size: 1rem; outline: none;
        }
        .form-input:focus { border-color: var(--nolan-gold); }
        
        /* Date Input Specifics */
        input[type="datetime-local"]::-webkit-calendar-picker-indicator { filter: invert(1); cursor: pointer; }

        /* Tiers */
        .tier-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 15px; }
        .tier-btn {
            padding: 10px; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1);
            border-radius: 4px; cursor: pointer; text-align: center; transition: 0.2s;
        }
        .tier-btn:hover { background: rgba(255,255,255,0.08); }
        .tier-btn.active { border-width: 2px; background: rgba(255,255,255,0.1); }
        .t25 .tier-name { color: var(--orbit-25); } .tier-btn.active.t25 { border-color: var(--orbit-25); }
        .t50 .tier-name { color: var(--orbit-50); } .tier-btn.active.t50 { border-color: var(--orbit-50); }
        .t75 .tier-name { color: var(--orbit-75); } .tier-btn.active.t75 { border-color: var(--orbit-75); }
        .tinf .tier-name { color: var(--orbit-infinity); } .tier-btn.active.tinf { border-color: var(--orbit-infinity); }

        .btn-main {
            width: 100%; padding: 15px; margin-top: 15px; border: none; cursor: pointer;
            font-family: 'Bebas Neue'; font-size: 1.2rem; letter-spacing: 2px;
            background: linear-gradient(90deg, var(--nolan-gold), var(--nolan-orange)); color: #000;
            border-radius: 4px;
        }
        .btn-main.updating { background: linear-gradient(90deg, var(--nolan-orange), #ff4500); color: white; }

        /* --- ORBIT SPACE (Draggable Area) --- */
        .orbit-space {
            position: relative; width: 100%; height: 100%;
            background: radial-gradient(circle, rgba(255,255,255,0.02) 0%, transparent 70%);
            overflow: hidden; /* Planets stay inside */
        }
        
        /* 3D CARD CONTAINER */
        .orbit-container {
            position: absolute; width: 150px; height: 150px; perspective: 1000px;
            cursor: grab; z-index: 10;
        }
        .orbit-container:active { cursor: grabbing; z-index: 100; }

        .orbit-card {
            position: relative; width: 100%; height: 100%; text-align: center;
            transition: transform 0.6s; transform-style: preserve-3d;
        }
        .orbit-container.flipped .orbit-card { transform: rotateY(180deg); }

        /* CARD FACES */
        .orbit-face {
            position: absolute; width: 100%; height: 100%;
            -webkit-backface-visibility: hidden; backface-visibility: hidden;
            border-radius: 50%; display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: rgba(10, 22, 40, 0.9); border: 1px solid rgba(255,255,255,0.2);
            box-shadow: 0 0 15px rgba(0,0,0,0.5);
        }

        /* FRONT FACE (Planet Visual) */
        .orbit-face-front::before {
            content: ''; position: absolute; inset: -5px; border-radius: 50%;
            border: 1px dashed transparent; animation: rotate 20s linear infinite; pointer-events: none;
        }
        .t25 .orbit-face-front::before { border-color: var(--orbit-25); }
        .t50 .orbit-face-front::before { border-color: var(--orbit-50); }
        .t75 .orbit-face-front::before { border-color: var(--orbit-75); }
        .tinf .orbit-face-front::before { border-color: var(--orbit-infinity); }

        .planet-icon { font-size: 2.5rem; margin-bottom: 5px; pointer-events: none; }
        .planet-name { font-family: 'Rajdhani'; font-weight: 700; font-size: 1rem; max-width: 90%; overflow: hidden; white-space: nowrap; pointer-events: none; }

        /* BACK FACE (Flash Card Info) */
        .orbit-face-back {
            transform: rotateY(180deg); border-radius: 10px; /* Square card for info */
            background: #0f1926; border: 1px solid var(--nolan-gold);
            padding: 10px; align-items: flex-start; text-align: left;
        }
        .card-label { font-family: 'Orbitron'; font-size: 0.5rem; color: #666; margin-top: 5px; }
        .card-val { font-size: 0.8rem; color: #fff; line-height: 1.1; margin-bottom: 2px; }
        .card-obj { font-size: 0.7rem; color: #aaa; font-style: italic; max-height: 35px; overflow: hidden; }
        .card-deadline { color: var(--orbit-75); font-weight: bold; }

        /* CARD CONTROLS */
        .orbit-controls {
            position: absolute; top: 0; right: 0; display: flex; gap: 5px; z-index: 20;
        }
        .ctrl-btn {
            width: 24px; height: 24px; background: #000; border: 1px solid #444; color: #888;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            cursor: pointer; font-size: 10px; transition: 0.2s;
        }
        .ctrl-btn:hover { color: white; border-color: white; transform: scale(1.1); }
        .ctrl-info { border-color: var(--nolan-gold); color: var(--nolan-gold); }
        .ctrl-edit { border-color: var(--nolan-orange); color: var(--nolan-orange); }

        /* --- ACTIVE MISSION --- */
        .active-overlay {
            position: absolute; inset: 0; background: rgba(0,0,0,0.95); z-index: 500;
            display: none; flex-direction: column; align-items: center; justify-content: center;
        }
        .active-overlay.show { display: flex; }
        .timer-display { font-family: 'Bebas Neue'; font-size: 6rem; line-height: 1; color: var(--nolan-gold); }
        
        /* --- HELPERS --- */
        .process-list { flex: 1; overflow-y: auto; min-height: 100px; margin-top: 10px; }
        .process-item { display: flex; gap: 5px; padding: 5px; border-bottom: 1px solid #333; font-size: 0.8rem; }
        .btn-add { background: none; border: 1px solid var(--nolan-gold); color: var(--nolan-gold); font-size: 0.6rem; padding: 2px 8px; cursor: pointer; }
        
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 1000; display: none; align-items: center; justify-content: center; }
        .modal.open { display: flex; }
        .modal-box { background: #0a1628; border: 1px solid var(--nolan-gold); padding: 20px; width: 300px; }

        @keyframes rotate { 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div class="space-bg"></div>
    <div class="stars" id="stars"></div>

    <div class="app-container">
        <header class="header">
            <h1 class="title">INFINITY ORBIT</h1>
        </header>

        <div class="dashboard">
            
            <div class="panel" id="panelEditor">
                <div class="panel-header">
                    <div class="panel-dot"></div>
                    <span class="panel-title" id="editorTitle">MISSION CREATOR</span>
                </div>
                <div class="panel-body">
                    <div class="tier-grid">
                        <div class="tier-btn t25" onclick="setTier('25', 25)"><div class="tier-name">25</div></div>
                        <div class="tier-btn t50" onclick="setTier('50', 50)"><div class="tier-name">50</div></div>
                        <div class="tier-btn t75" onclick="setTier('75', 75)"><div class="tier-name">75</div></div>
                        <div class="tier-btn tinf" onclick="setTier('inf', 90)"><div class="tier-name">∞</div></div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Orbit Name</label>
                        <input type="text" class="form-input" id="inpName" placeholder="e.g. Coding...">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Objective (Flash Card)</label>
                        <input type="text" class="form-input" id="inpObj" placeholder="Goal for this orbit...">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Deadline</label>
                        <input type="datetime-local" class="form-input" id="inpDeadline">
                    </div>

                    <div class="process-section" style="flex:1; display:flex; flex-direction:column;">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <span class="form-label">PROCESSES</span>
                            <button class="btn-add" onclick="openProcessModal()">+ ADD</button>
                        </div>
                        <div class="process-list" id="editorProcessList"></div>
                    </div>

                    <button class="btn-main" id="btnAction" onclick="handleDockAction()">ADD TO SPACE</button>
                    <button id="btnCancelEdit" style="display:none; width:100%; background:transparent; border:none; color:#555; margin-top:10px; cursor:pointer;" onclick="cancelEdit()">CANCEL</button>
                </div>
            </div>

            <div class="panel" style="background: rgba(0,0,0,0.3); border: none; overflow: hidden;">
                <div class="orbit-space" id="orbitSpace">
                    <div style="position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); opacity: 0.5; font-size: 0.7rem; pointer-events: none;">
                        DRAG TO MOVE • DOUBLE CLICK TO LAUNCH
                    </div>
                </div>
            </div>

            <div class="panel">
                <div class="panel-header">
                    <div class="panel-dot"></div>
                    <span class="panel-title">LOGS</span>
                </div>
                <div class="panel-body" id="historyList"></div>
                <button onclick="clearLogs()" style="background:transparent; border:none; color:#444; font-size:0.6rem; padding:10px; cursor:pointer;">CLEAR HISTORY</button>
            </div>
        </div>
    </div>

    <div class="active-overlay" id="activeOverlay">
        <div style="font-family:'Orbitron'; color:#888; letter-spacing:4px;">CURRENT ORBIT</div>
        <div class="timer-display" id="timerDisplay">00:00</div>
        <div id="activeNameDisplay" style="font-size:1.5rem; margin-top:10px;">NAME</div>
        <div style="width:300px; margin-top:20px;">
            <div style="height:4px; background:#333; width:100%;"><div id="scoreBar" style="height:100%; width:100%; background:var(--nolan-gold);"></div></div>
            <div style="text-align:right; font-size:0.8rem; margin-top:5px; color:var(--nolan-gold);" id="scoreValue">100% INTEGRITY</div>
        </div>
        <div id="activeChecklist" style="margin-top:20px; width:300px; max-height:200px; overflow-y:auto; background:#111; padding:10px;"></div>
        <div style="margin-top:20px; display:flex; gap:20px;">
            <button class="btn-main" style="width:auto; padding:10px 30px; background:#333; border:1px solid #555;" onclick="abortMission()">ABORT</button>
            <button class="btn-main" style="width:auto; padding:10px 30px;" onclick="finishMission()">COMPLETE</button>
        </div>
    </div>

    <div class="modal" id="modalProcess">
        <div class="modal-box">
            <h3 style="color:var(--nolan-gold); margin-bottom:10px;">ADD PROCESS</h3>
            <input type="text" class="form-input" id="inpProcText" placeholder="Description...">
            <div style="display:flex; gap:10px; margin-top:10px;">
                <button class="btn-main" style="flex:1; padding:8px; background:var(--process-pos);" onclick="confirmAddProcess('pos')">BUILD (+)</button>
                <button class="btn-main" style="flex:1; padding:8px; background:var(--process-neg);" onclick="confirmAddProcess('neg')">BURN (-)</button>
            </div>
            <button onclick="closeProcessModal()" style="width:100%; background:transparent; border:none; color:#666; margin-top:10px; cursor:pointer;">CANCEL</button>
        </div>
    </div>

    <script>
        // --- STATE & CONFIG ---
        const state = {
            dock: [], // {id, x, y, name, obj, deadline, tier, duration, processes}
            history: [],
            editor: { isEditing: false, editId: null, tier: null, time: 0, processes: [] },
            active: null,
            timer: null
        };
        const colors = { '25': '#4ecdc4', '50': '#ffe66d', '75': '#ff6b6b', 'inf': '#a855f7' };

        // --- DOM ---
        const dom = {
            inpName: document.getElementById('inpName'),
            inpObj: document.getElementById('inpObj'),
            inpDeadline: document.getElementById('inpDeadline'),
            editorList: document.getElementById('editorProcessList'),
            orbitSpace: document.getElementById('orbitSpace'),
            historyList: document.getElementById('historyList'),
            activeOverlay: document.getElementById('activeOverlay'),
            modalProcess: document.getElementById('modalProcess'),
            inpProcText: document.getElementById('inpProcText'),
            // Active
            timerDisplay: document.getElementById('timerDisplay'),
            activeName: document.getElementById('activeNameDisplay'),
            scoreBar: document.getElementById('scoreBar'),
            scoreValue: document.getElementById('scoreValue'),
            activeChecklist: document.getElementById('activeChecklist'),
            // Editor
            editorTitle: document.getElementById('editorTitle'),
            btnAction: document.getElementById('btnAction'),
            btnCancelEdit: document.getElementById('btnCancelEdit')
        };

        // --- INIT ---
        window.onload = () => {
            createStars();
            loadData();
            renderSpace();
            renderHistory();
        };

        function createStars() {
            const el = document.getElementById('stars');
            for(let i=0; i<80; i++){
                let d = document.createElement('div');
                d.className='star';
                d.style.left = Math.random()*100+'%';
                d.style.top = Math.random()*100+'%';
                d.style.width = Math.random()*2+'px';
                d.style.height = d.style.width;
                el.appendChild(d);
            }
        }

        // --- EDITOR ---
        function setTier(tier, time) {
            state.editor.tier = tier;
            state.editor.time = time;
            document.querySelectorAll('.tier-btn').forEach(b => b.classList.remove('active'));
            document.querySelector(`.tier-btn.t${tier}`).classList.add('active');
        }

        function openProcessModal() { dom.modalProcess.classList.add('open'); dom.inpProcText.focus(); }
        function closeProcessModal() { dom.modalProcess.classList.remove('open'); dom.inpProcText.value = ''; }
        
        function confirmAddProcess(type) {
            const txt = dom.inpProcText.value.trim();
            if(!txt) return;
            state.editor.processes.push({text: txt, type: type});
            renderEditorList();
            closeProcessModal();
        }

        function renderEditorList() {
            dom.editorList.innerHTML = '';
            state.editor.processes.forEach((p, i) => {
                const d = document.createElement('div');
                d.className = 'process-item';
                d.style.color = p.type==='pos' ? 'var(--process-pos)' : 'var(--process-neg)';
                d.innerHTML = `<span>${p.text}</span> <span style="margin-left:auto; cursor:pointer;" onclick="removeProc(${i})">×</span>`;
                dom.editorList.appendChild(d);
            });
        }
        function removeProc(i) { state.editor.processes.splice(i,1); renderEditorList(); }

        // --- DOCK ACTIONS ---
        function handleDockAction() {
            const name = dom.inpName.value.trim();
            if(!name || !state.editor.tier) return alert("Tier and Name required.");

            const data = {
                id: state.editor.isEditing ? state.editor.editId : Date.now(),
                name: name,
                obj: dom.inpObj.value.trim() || 'No Objective',
                deadline: dom.inpDeadline.value || '',
                tier: state.editor.tier,
                duration: state.editor.time,
                processes: [...state.editor.processes],
                x: state.editor.isEditing ? getOrbitById(state.editor.editId).x : 50,
                y: state.editor.isEditing ? getOrbitById(state.editor.editId).y : 50
            };

            if(state.editor.isEditing) {
                const idx = state.dock.findIndex(o => o.id === data.id);
                state.dock[idx] = data;
                cancelEdit();
            } else {
                state.dock.push(data);
                resetEditor();
            }
            saveData();
            renderSpace();
        }

        function getOrbitById(id) { return state.dock.find(o => o.id === id); }

        function resetEditor() {
            state.editor = { isEditing: false, editId: null, tier: null, time: 0, processes: [] };
            dom.inpName.value = ''; dom.inpObj.value = ''; dom.inpDeadline.value = '';
            dom.editorList.innerHTML = '';
            document.querySelectorAll('.tier-btn').forEach(b => b.classList.remove('active'));
            dom.editorTitle.innerText = "MISSION CREATOR";
            dom.btnAction.innerText = "ADD TO SPACE";
            dom.btnAction.classList.remove('updating');
            dom.btnCancelEdit.style.display = 'none';
            document.getElementById('panelEditor').classList.remove('editing');
        }

        function editOrbit(id) {
            const orb = getOrbitById(id);
            state.editor.isEditing = true;
            state.editor.editId = id;
            state.editor.tier = orb.tier;
            state.editor.time = orb.duration;
            state.editor.processes = [...orb.processes];

            dom.inpName.value = orb.name;
            dom.inpObj.value = orb.obj;
            dom.inpDeadline.value = orb.deadline;
            setTier(orb.tier, orb.duration);
            renderEditorList();

            dom.editorTitle.innerText = "EDITING ORBIT";
            dom.btnAction.innerText = "UPDATE ORBIT";
            dom.btnAction.classList.add('updating');
            dom.btnCancelEdit.style.display = 'block';
            document.getElementById('panelEditor').classList.add('editing');
        }

        function cancelEdit() { resetEditor(); }

        // --- ORBIT SPACE (DRAG & DROP) ---
        function renderSpace() {
            dom.orbitSpace.innerHTML = '';
            state.dock.forEach(orb => {
                // Card Container
                const cont = document.createElement('div');
                cont.className = `orbit-container t${orb.tier}`;
                cont.style.left = orb.x + 'px';
                cont.style.top = orb.y + 'px';
                cont.id = `orb-${orb.id}`;

                // Drag Logic
                let isDragging = false;
                let startX, startY;
                
                cont.onmousedown = (e) => {
                    // Ignore clicks on controls
                    if(e.target.closest('.orbit-controls')) return;
                    
                    isDragging = true;
                    startX = e.clientX - cont.offsetLeft;
                    startY = e.clientY - cont.offsetTop;
                    cont.style.zIndex = 100;
                };

                window.addEventListener('mousemove', (e) => {
                    if(!isDragging) return;
                    e.preventDefault();
                    let newX = e.clientX - startX;
                    let newY = e.clientY - startY;
                    
                    // Boundary check
                    const rect = dom.orbitSpace.getBoundingClientRect();
                    newX = Math.max(0, Math.min(newX, rect.width - 150));
                    newY = Math.max(0, Math.min(newY, rect.height - 150));

                    cont.style.left = newX + 'px';
                    cont.style.top = newY + 'px';
                });

                cont.onmouseup = () => {
                    if(isDragging) {
                        isDragging = false;
                        cont.style.zIndex = 10;
                        orb.x = parseInt(cont.style.left);
                        orb.y = parseInt(cont.style.top);
                        saveData();
                    }
                };

                // Double click to launch
                cont.ondblclick = () => launchMission(orb.id);

                // HTML Structure
                const dlDisplay = orb.deadline ? new Date(orb.deadline).toLocaleDateString() : 'None';
                
                cont.innerHTML = `
                    <div class="orbit-controls">
                        <div class="ctrl-btn ctrl-edit" onclick="editOrbit(${orb.id})">✎</div>
                        <div class="ctrl-btn ctrl-info" onclick="toggleFlip(${orb.id})">i</div>
                    </div>
                    <div class="orbit-card">
                        <div class="orbit-face orbit-face-front">
                            <div class="planet-icon">●</div>
                            <div class="planet-name">${orb.name}</div>
                            <div style="font-size:0.6rem; opacity:0.6; margin-top:5px;">${orb.duration} MIN</div>
                        </div>
                        <div class="orbit-face orbit-face-back">
                            <div class="card-label">OBJECTIVE</div>
                            <div class="card-obj">"${orb.obj}"</div>
                            <div class="card-label">DEADLINE</div>
                            <div class="card-val card-deadline">${dlDisplay}</div>
                            <div class="card-label">TIER</div>
                            <div class="card-val">${orb.tier.toUpperCase()}</div>
                        </div>
                    </div>
                `;
                dom.orbitSpace.appendChild(cont);
            });
        }

        function toggleFlip(id) {
            const el = document.getElementById(`orb-${id}`);
            el.classList.toggle('flipped');
        }

        // --- MISSION RUNNER ---
        function launchMission(id) {
            const orb = getOrbitById(id);
            state.active = {
                data: orb,
                timeLeft: orb.duration * 60,
                checklist: orb.processes.map(p => ({...p, done: false}))
            };

            dom.activeOverlay.classList.add('show');
            dom.activeName.innerText = orb.name;
            renderChecklist();
            updateScore();
            startTimer();
        }

        function renderChecklist() {
            dom.activeChecklist.innerHTML = '';
            state.active.checklist.forEach((p, i) => {
                const div = document.createElement('div');
                div.style.display = 'flex';
                div.style.alignItems = 'center';
                div.style.padding = '8px';
                div.style.borderBottom = '1px solid #333';
                div.style.cursor = 'pointer';
                div.style.opacity = p.done ? '0.5' : '1';
                div.onclick = () => { p.done = !p.done; renderChecklist(); updateScore(); };
                
                div.innerHTML = `
                    <div style="width:15px; height:15px; border:1px solid #555; background:${p.done?colors[state.active.data.tier]:'transparent'}; margin-right:10px;"></div>
                    <div style="color:${p.type==='pos'?'#4ecdc4':'#ff6b6b'}">${p.text}</div>
                `;
                dom.activeChecklist.appendChild(div);
            });
        }

        function updateScore() {
            const list = state.active.checklist;
            const pos = list.filter(x => x.type === 'pos');
            const neg = list.filter(x => x.type === 'neg');
            
            let score = 100;
            // Simplified scoring: Start 100. -15 for every Neg done. - (100/TotalPos) for every Pos missed.
            if(pos.length > 0) {
                const val = 100 / pos.length;
                const missed = pos.filter(x => !x.done).length;
                score -= (missed * val);
            }
            const negHits = neg.filter(x => x.done).length;
            score -= (negHits * 15);
            
            score = Math.max(0, Math.round(score));
            state.active.score = score;
            dom.scoreValue.innerText = score + "% INTEGRITY";
            dom.scoreBar.style.width = score + "%";
        }

        function startTimer() {
            clearInterval(state.timer);
            updateTimer();
            state.timer = setInterval(() => {
                state.active.timeLeft--;
                updateTimer();
                if(state.active.timeLeft <= 0) { clearInterval(state.timer); }
            }, 1000);
        }

        function updateTimer() {
            const m = Math.floor(state.active.timeLeft / 60);
            const s = state.active.timeLeft % 60;
            dom.timerDisplay.innerText = `${m}:${s.toString().padStart(2,'0')}`;
        }

        function finishMission() { closeMission('COMPLETE'); }
        function abortMission() { closeMission('ABORTED'); }

        function closeMission(status) {
            clearInterval(state.timer);
            dom.activeOverlay.classList.remove('show');
            state.history.unshift({
                name: state.active.data.name,
                score: state.active.score,
                status: status,
                date: new Date().toLocaleTimeString()
            });
            saveData();
            renderHistory();
            state.active = null;
        }

        // --- DATA ---
        function renderHistory() {
            dom.historyList.innerHTML = '';
            state.history.forEach(h => {
                const d = document.createElement('div');
                d.style.padding = '10px';
                d.style.borderBottom = '1px solid #333';
                d.innerHTML = `
                    <div style="display:flex; justify-content:space-between;">
                        <span style="color:var(--nolan-gold)">${h.name}</span>
                        <span style="font-size:0.7rem; color:#666">${h.date}</span>
                    </div>
                    <div style="font-size:0.8rem; display:flex; justify-content:space-between;">
                        <span>${h.status}</span>
                        <span>${h.score}%</span>
                    </div>
                `;
                dom.historyList.appendChild(d);
            });
        }

        function saveData() { localStorage.setItem('infOrbitV4', JSON.stringify({dock:state.dock, history:state.history})); }
        function loadData() {
            const d = JSON.parse(localStorage.getItem('infOrbitV4'));
            if(d) { state.dock = d.dock || []; state.history = d.history || []; }
        }
        function clearLogs() { state.history = []; saveData(); renderHistory(); }
    </script>
</body>
</html>
