<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>INFINITY ORBIT v5 ‚Äî Holographic Command</title>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Rajdhani:wght@300;400;500;600;700&family=Orbitron:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        /* --- CORE --- */
        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }
        :root {
            --gold: #c9a227;
            --orange: #d4740c;
            --t25: #4ecdc4; --t50: #ffe66d; --t75: #ff6b6b; --tinf: #a855f7;
            --glass: rgba(10, 22, 40, 0.65);
            --border: rgba(255, 255, 255, 0.15);
        }
        body {
            height: 100vh; background: #050505; font-family: 'Rajdhani', sans-serif;
            overflow: hidden; color: #fff;
        }

        /* --- BACKGROUND (Holographic Grid) --- */
        .grid-bg {
            position: fixed; inset: 0; z-index: 0;
            background-image: 
                linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
            background-size: 40px 40px;
            mask-image: radial-gradient(circle at center, black 40%, transparent 100%);
            -webkit-mask-image: radial-gradient(circle at center, black 40%, transparent 100%);
            pointer-events: none;
        }

        /* --- LAYOUT --- */
        .app { position: relative; z-index: 10; height: 100vh; display: grid; grid-template-rows: 60px 1fr; padding: 10px; gap: 10px; }
        
        .header { display: flex; align-items: center; justify-content: center; border-bottom: 1px solid var(--border); }
        .logo { font-family: 'Bebas Neue'; font-size: 2rem; letter-spacing: 5px; background: linear-gradient(to right, #fff, var(--gold)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

        .workspace { display: grid; grid-template-columns: 320px 1fr 280px; gap: 15px; height: 100%; overflow: hidden; }
        @media (max-width: 1024px) { .workspace { grid-template-columns: 1fr; } .side-panel { display: none; } .mobile-menu-btn { display: block; } }

        /* --- PANELS (Glassmorphism) --- */
        .panel {
            background: var(--glass); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--border); border-radius: 8px; display: flex; flex-direction: column;
            transition: 0.3s;
        }
        .panel.active { border-color: var(--gold); box-shadow: 0 0 20px rgba(201, 162, 39, 0.15); }

        .panel-head { padding: 12px; border-bottom: 1px solid var(--border); font-family: 'Orbitron'; font-size: 0.7rem; color: var(--gold); letter-spacing: 2px; display: flex; align-items: center; gap: 8px; }
        .panel-dot { width: 6px; height: 6px; background: var(--gold); border-radius: 50%; box-shadow: 0 0 8px var(--gold); }
        .panel-body { padding: 15px; flex: 1; overflow-y: auto; }

        /* --- INPUTS --- */
        .input-group { margin-bottom: 12px; }
        .label { font-family: 'Orbitron'; font-size: 0.5rem; color: #888; margin-bottom: 4px; display: block; }
        .input {
            width: 100%; background: rgba(0,0,0,0.4); border: 1px solid var(--border); color: white;
            padding: 8px 10px; font-family: 'Rajdhani'; font-size: 1rem; outline: none; border-radius: 4px;
        }
        .input:focus { border-color: var(--gold); }
        
        /* Tiers */
        .tiers { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; margin-bottom: 15px; }
        .tier {
            padding: 8px 0; text-align: center; border: 1px solid var(--border); border-radius: 4px; cursor: pointer;
            background: rgba(255,255,255,0.02); transition: 0.2s;
        }
        .tier.active { border-width: 2px; background: rgba(255,255,255,0.08); }
        .t-name { font-family: 'Bebas Neue'; font-size: 1.1rem; }
        
        /* Color Mapping */
        .t25 .t-name { color: var(--t25); } .tier.active.t25 { border-color: var(--t25); }
        .t50 .t-name { color: var(--t50); } .tier.active.t50 { border-color: var(--t50); }
        .t75 .t-name { color: var(--t75); } .tier.active.t75 { border-color: var(--t75); }
        .tinf .t-name { color: var(--tinf); } .tier.active.tinf { border-color: var(--tinf); }

        .btn {
            width: 100%; padding: 12px; background: linear-gradient(90deg, var(--gold), var(--orange));
            border: none; border-radius: 4px; font-family: 'Bebas Neue'; font-size: 1.1rem; letter-spacing: 1px;
            color: black; cursor: pointer; margin-top: 10px; transition: 0.2s;
        }
        .btn:hover { filter: brightness(1.1); }

        /* --- ORBIT SPACE (Physics Area) --- */
        .space-area { position: relative; width: 100%; height: 100%; overflow: hidden; }
        
        /* 3D ORBIT CARD */
        .orb-wrapper {
            position: absolute; width: 160px; height: 160px; perspective: 1000px;
            cursor: grab; z-index: 10; touch-action: none; /* Critical for mobile drag */
        }
        .orb-wrapper:active { cursor: grabbing; z-index: 100 !important; }

        .orb-card {
            width: 100%; height: 100%; position: relative; transform-style: preserve-3d; transition: transform 0.6s cubic-bezier(0.4, 0.0, 0.2, 1);
        }
        .orb-wrapper.flipped .orb-card { transform: rotateY(180deg); }

        .face {
            position: absolute; inset: 0; backface-visibility: hidden; -webkit-backface-visibility: hidden;
            border-radius: 50%; display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: rgba(15, 25, 40, 0.85); backdrop-filter: blur(5px);
            border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        
        /* Front */
        .face-front::after {
            content: ''; position: absolute; inset: -4px; border-radius: 50%;
            border: 1px dashed var(--c); animation: spin 30s linear infinite; pointer-events: none;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .orb-icon { font-size: 3rem; color: var(--c); text-shadow: 0 0 20px var(--c); margin-bottom: 5px; }
        .orb-title { font-family: 'Rajdhani'; font-weight: 700; font-size: 1rem; max-width: 90%; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* Back */
        .face-back {
            transform: rotateY(180deg); border-radius: 12px; padding: 15px; align-items: flex-start;
            background: rgba(10, 15, 25, 0.95); border-color: var(--c);
        }
        .meta-lbl { font-family: 'Orbitron'; font-size: 0.5rem; color: #666; margin-top: 8px; }
        .meta-val { font-size: 0.9rem; line-height: 1.1; }
        .meta-date { font-weight: bold; }
        .meta-date.overdue { color: #ff4444; }

        /* Controls on Orbit */
        .orb-ctrls {
            position: absolute; top: -10px; right: -15px; display: flex; flex-direction: column; gap: 5px; z-index: 20;
        }
        .ctrl-btn {
            width: 30px; height: 30px; background: #000; border: 1px solid #333; border-radius: 50%;
            color: #888; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s;
        }
        .ctrl-btn:hover { transform: scale(1.1); color: white; border-color: white; }
        .c-launch { border-color: var(--gold); color: var(--gold); box-shadow: 0 0 10px rgba(201, 162, 39, 0.3); }

        /* --- HUD OVERLAY (Active Mission) --- */
        .hud-overlay {
            position: fixed; inset: 0; background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(5px);
            z-index: 1000; display: none; align-items: center; justify-content: center; flex-direction: column;
        }
        .hud-overlay.active { display: flex; }

        .hud-timer { font-family: 'Bebas Neue'; font-size: 7rem; line-height: 1; color: var(--gold); text-shadow: 0 0 30px rgba(201, 162, 39, 0.3); }
        .hud-title { font-family: 'Orbitron'; letter-spacing: 5px; color: #888; margin-bottom: 20px; }
        
        .hud-integrity { width: 300px; margin-bottom: 20px; }
        .bar-track { width: 100%; height: 6px; background: #333; border-radius: 3px; overflow: hidden; }
        .bar-fill { height: 100%; background: var(--t25); width: 100%; transition: 0.5s; box-shadow: 0 0 10px var(--t25); }
        .hud-score { text-align: right; font-family: 'Orbitron'; font-size: 0.7rem; color: var(--t25); margin-top: 5px; }

        .hud-tasks { width: 320px; max-height: 300px; overflow-y: auto; background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px; border: 1px solid #333; }
        .task-row { display: flex; align-items: center; gap: 10px; padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.05); cursor: pointer; transition: 0.2s; }
        .task-row:hover { background: rgba(255,255,255,0.05); }
        .task-chk { width: 16px; height: 16px; border: 1px solid #666; display: flex; align-items: center; justify-content: center; font-size: 10px; color: black; }
        .task-row.done .task-chk { background: var(--t25); border-color: var(--t25); }
        .task-row.done.neg .task-chk { background: var(--t75); border-color: var(--t75); }
        
        .hud-actions { display: flex; gap: 20px; margin-top: 30px; }
        .hud-btn { padding: 10px 30px; background: transparent; border: 1px solid #444; color: #fff; font-family: 'Orbitron'; cursor: pointer; }
        .hud-btn.abort:hover { border-color: var(--t75); color: var(--t75); }
        .hud-btn.finish:hover { border-color: var(--t25); color: var(--t25); }

        /* --- LOGS --- */
        .log-item { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.1); font-size: 0.9rem; }
        .log-score { font-family: 'Bebas Neue'; font-size: 1.2rem; }

        /* --- HELPERS --- */
        .hidden { display: none; }
        .proc-tag { font-size: 0.6rem; padding: 2px 5px; border-radius: 2px; margin-right: 5px; color: black; font-weight: bold; }
        .tag-pos { background: var(--t25); } .tag-neg { background: var(--t75); }
    </style>
</head>
<body>

    <div class="grid-bg"></div>

    <div class="app">
        <header class="header">
            <div class="logo">INFINITY ORBIT</div>
        </header>

        <div class="workspace">
            <div class="panel side-panel" id="editorPanel">
                <div class="panel-head">
                    <div class="panel-dot"></div> <span id="editorTitle">MISSION COMMAND</span>
                </div>
                <div class="panel-body">
                    <div class="tiers">
                        <div class="tier t25" onclick="setTier('25', 25)"><div class="t-name">25</div></div>
                        <div class="tier t50" onclick="setTier('50', 50)"><div class="t-name">50</div></div>
                        <div class="tier t75" onclick="setTier('75', 75)"><div class="t-name">75</div></div>
                        <div class="tier tinf" onclick="setTier('inf', 90)"><div class="t-name">‚àû</div></div>
                    </div>
                    
                    <div class="input-group">
                        <label class="label">CODENAME</label>
                        <input type="text" class="input" id="inpName" placeholder="e.g. Python Study">
                    </div>
                    <div class="input-group">
                        <label class="label">OBJECTIVE (FLASH CARD)</label>
                        <input type="text" class="input" id="inpObj" placeholder="Goal for the session...">
                    </div>
                    <div class="input-group">
                        <label class="label">DEADLINE</label>
                        <input type="datetime-local" class="input" id="inpDeadline" style="filter:invert(1);">
                    </div>

                    <div style="margin-top:20px; border-top:1px solid var(--border); padding-top:10px;">
                        <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                            <label class="label">PROCESS PROTOCOLS</label>
                            <button onclick="toggleProcMode()" style="background:none; border:1px solid var(--gold); color:var(--gold); font-size:10px; padding:2px 8px; cursor:pointer;">+ ADD</button>
                        </div>
                        <div id="procInputs" class="hidden" style="display:flex; gap:5px; margin-bottom:10px;">
                            <input id="newProcTxt" class="input" style="font-size:0.8rem;" placeholder="Task...">
                            <button onclick="addProc('pos')" style="background:var(--t25); border:none; width:30px;">+</button>
                            <button onclick="addProc('neg')" style="background:var(--t75); border:none; width:30px;">-</button>
                        </div>
                        <div id="editorProcs" style="max-height:150px; overflow-y:auto;"></div>
                    </div>

                    <button class="btn" id="btnSave" onclick="saveOrbit()">DEPLOY ORBIT</button>
                    <button id="btnCancel" class="hidden" onclick="resetEditor()" style="width:100%; background:transparent; border:none; color:#666; margin-top:10px; cursor:pointer;">CANCEL UPDATE</button>
                </div>
            </div>

            <div class="panel space-area" id="spaceArea">
                <div style="position:absolute; bottom:10px; left:50%; transform:translateX(-50%); font-family:'Orbitron'; font-size:0.6rem; color:rgba(255,255,255,0.3); pointer-events:none;">
                    DRAG TO ARRANGE ‚Ä¢ CLICK ROCKET TO LAUNCH
                </div>
            </div>

            <div class="panel side-panel">
                <div class="panel-head">
                    <div class="panel-dot"></div> FLIGHT LOGS
                </div>
                <div class="panel-body" id="logList"></div>
                <button onclick="clearLogs()" style="background:transparent; border:none; color:#444; font-size:0.6rem; padding:10px; cursor:pointer;">PURGE DATA</button>
            </div>
        </div>
    </div>

    <div class="hud-overlay" id="hud">
        <div class="hud-title" id="hudName">MISSION ACTIVE</div>
        <div class="hud-timer" id="hudTimer">00:00</div>
        
        <div class="hud-integrity">
            <div class="bar-track"><div class="bar-fill" id="hudBar"></div></div>
            <div class="hud-score" id="hudScore">100% INTEGRITY</div>
        </div>

        <div class="hud-tasks" id="hudList"></div>

        <div class="hud-actions">
            <button class="hud-btn abort" onclick="endMission('ABORTED')">ABORT</button>
            <button class="hud-btn finish" onclick="endMission('COMPLETE')">FINISH</button>
        </div>
    </div>

    <script>
        // --- CONFIG ---
        const colors = { '25': '#4ecdc4', '50': '#ffe66d', '75': '#ff6b6b', 'inf': '#a855f7' };
        const state = {
            dock: [],
            history: [],
            editor: { editing: false, id: null, tier: null, duration: 0, procs: [] },
            active: null,
            timerId: null
        };

        // --- DOM ---
        const $ = (id) => document.getElementById(id);

        // --- INIT ---
        window.onload = () => {
            loadData();
            renderSpace();
            renderLogs();
        };

        // --- EDITOR LOGIC ---
        function setTier(t, d) {
            state.editor.tier = t; 
            state.editor.duration = d;
            document.querySelectorAll('.tier').forEach(el => el.classList.remove('active'));
            document.querySelector(`.t${t}`).classList.add('active');
        }

        function toggleProcMode() { $('procInputs').classList.toggle('hidden'); $('newProcTxt').focus(); }

        function addProc(type) {
            const txt = $('newProcTxt').value.trim();
            if(!txt) return;
            state.editor.procs.push({ text: txt, type: type });
            $('newProcTxt').value = '';
            renderEditorProcs();
        }

        function renderEditorProcs() {
            $('editorProcs').innerHTML = state.editor.procs.map((p, i) => `
                <div style="display:flex; justify-content:space-between; padding:5px; border-bottom:1px solid rgba(255,255,255,0.1); font-size:0.8rem;">
                    <div><span class="proc-tag ${p.type === 'pos' ? 'tag-pos' : 'tag-neg'}">${p.type === 'pos' ? '+' : '-'}</span> ${p.text}</div>
                    <div style="cursor:pointer;" onclick="delProc(${i})">√ó</div>
                </div>
            `).join('');
        }
        function delProc(i) { state.editor.procs.splice(i, 1); renderEditorProcs(); }

        function saveOrbit() {
            const name = $('inpName').value.trim();
            if (!name || !state.editor.tier) return alert("Name and Tier required");

            const data = {
                id: state.editor.editing ? state.editor.id : Date.now(),
                name: name,
                obj: $('inpObj').value || 'No Objective',
                deadline: $('inpDeadline').value,
                tier: state.editor.tier,
                duration: state.editor.duration,
                procs: [...state.editor.procs],
                x: state.editor.editing ? getOrbit(state.editor.id).x : 50,
                y: state.editor.editing ? getOrbit(state.editor.id).y : 50
            };

            if (state.editor.editing) {
                const idx = state.dock.findIndex(o => o.id === data.id);
                state.dock[idx] = data;
            } else {
                state.dock.push(data);
            }
            
            saveData();
            renderSpace();
            resetEditor();
        }

        function editOrbit(id) {
            const o = getOrbit(id);
            state.editor = { editing: true, id: id, tier: o.tier, duration: o.duration, procs: [...o.procs] };
            $('inpName').value = o.name;
            $('inpObj').value = o.obj;
            $('inpDeadline').value = o.deadline;
            setTier(o.tier, o.duration);
            renderEditorProcs();
            
            $('editorTitle').innerText = "EDITING SIGNAL";
            $('btnSave').innerText = "UPDATE ORBIT";
            $('editorPanel').classList.add('active');
            $('btnCancel').classList.remove('hidden');
        }

        function resetEditor() {
            state.editor = { editing: false, id: null, tier: null, duration: 0, procs: [] };
            $('inpName').value = ''; $('inpObj').value = ''; $('inpDeadline').value = ''; $('editorProcs').innerHTML = '';
            document.querySelectorAll('.tier').forEach(el => el.classList.remove('active'));
            $('editorTitle').innerText = "MISSION COMMAND";
            $('btnSave').innerText = "DEPLOY ORBIT";
            $('editorPanel').classList.remove('active');
            $('btnCancel').classList.add('hidden');
        }

        // --- SPACE & DRAG (MOUSE + TOUCH) ---
        function renderSpace() {
            $('spaceArea').innerHTML = state.dock.map(o => {
                const color = colors[o.tier];
                const date = o.deadline ? new Date(o.deadline) : null;
                const isOverdue = date && date < new Date();
                const dateStr = date ? date.toLocaleDateString() : 'None';
                
                return `
                <div class="orb-wrapper" id="orb-${o.id}" style="left:${o.x}px; top:${o.y}px;" onmousedown="startDrag(event, ${o.id})" ontouchstart="startDrag(event, ${o.id})">
                    
                    <div class="orb-ctrls">
                        <div class="ctrl-btn c-launch" onmousedown="event.stopPropagation()" ontouchstart="event.stopPropagation()" onclick="launchMission(${o.id})">üöÄ</div>
                        <div class="ctrl-btn" onmousedown="event.stopPropagation()" ontouchstart="event.stopPropagation()" onclick="editOrbit(${o.id})">‚úé</div>
                        <div class="ctrl-btn" onmousedown="event.stopPropagation()" ontouchstart="event.stopPropagation()" onclick="toggleFlip(${o.id})">i</div>
                    </div>

                    <div class="orb-card">
                        <div class="face face-front" style="--c:${color}">
                            <div class="orb-icon">‚óè</div>
                            <div class="orb-title">${o.name}</div>
                        </div>
                        <div class="face face-back" style="--c:${color}">
                            <div class="meta-lbl">OBJECTIVE</div>
                            <div class="meta-val" style="font-size:0.8rem; height:35px; overflow:hidden;">${o.obj}</div>
                            <div class="meta-lbl">DEADLINE</div>
                            <div class="meta-val meta-date ${isOverdue ? 'overdue' : ''}">${dateStr}</div>
                            <div class="meta-lbl">DURATION</div>
                            <div class="meta-val">${o.duration} MIN</div>
                        </div>
                    </div>
                </div>`;
            }).join('') + '<div style="position:absolute; bottom:10px; left:50%; transform:translateX(-50%); font-family:\'Orbitron\'; font-size:0.6rem; color:rgba(255,255,255,0.3); pointer-events:none;">DRAG TO ARRANGE ‚Ä¢ ROCKET TO LAUNCH</div>';
        }

        let drag = { active: false, id: null, offsetX: 0, offsetY: 0 };

        function startDrag(e, id) {
            if (e.target.closest('.orb-ctrls')) return; // Don't drag if clicking buttons
            // Prevent default only if not clicking an input (not relevant here but good practice)
            // e.preventDefault(); 
            
            const el = $(`orb-${id}`);
            const clientX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
            const clientY = e.type.includes('touch') ? e.touches[0].clientY : e.clientY;

            drag = { 
                active: true, 
                id: id, 
                offsetX: clientX - el.offsetLeft, 
                offsetY: clientY - el.offsetTop 
            };
            
            el.style.zIndex = 1000;
        }

        window.addEventListener('mousemove', doDrag);
        window.addEventListener('touchmove', doDrag, {passive: false});
        window.addEventListener('mouseup', endDrag);
        window.addEventListener('touchend', endDrag);

        function doDrag(e) {
            if (!drag.active) return;
            e.preventDefault(); // Stop scrolling on mobile
            
            const clientX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
            const clientY = e.type.includes('touch') ? e.touches[0].clientY : e.clientY;
            
            let x = clientX - drag.offsetX;
            let y = clientY - drag.offsetY;

            // Boundaries
            const rect = $('spaceArea').getBoundingClientRect();
            x = Math.max(0, Math.min(x, rect.width - 160));
            y = Math.max(0, Math.min(y, rect.height - 160));

            const el = $(`orb-${drag.id}`);
            el.style.left = x + 'px';
            el.style.top = y + 'px';
        }

        function endDrag() {
            if (!drag.active) return;
            const o = getOrbit(drag.id);
            const el = $(`orb-${drag.id}`);
            o.x = parseInt(el.style.left);
            o.y = parseInt(el.style.top);
            el.style.zIndex = 10;
            drag.active = false;
            saveData();
        }

        function toggleFlip(id) { $(`orb-${id}`).classList.toggle('flipped'); }
        function getOrbit(id) { return state.dock.find(o => o.id === id); }

        // --- ACTIVE MISSION ---
        function launchMission(id) {
            const o = getOrbit(id);
            state.active = { 
                data: o, 
                timeLeft: o.duration * 60, 
                checklist: o.procs.map(p => ({...p, done: false})) 
            };
            
            $('hudName').innerText = o.name.toUpperCase();
            $('hud').classList.add('active');
            renderHUDList();
            updateIntegrity();
            startTimer();
        }

        function renderHUDList() {
            $('hudList').innerHTML = state.active.checklist.map((p, i) => `
                <div class="task-row ${p.done ? 'done' : ''} ${p.type}" onclick="toggleTask(${i})">
                    <div class="task-chk">${p.done ? '‚úì' : ''}</div>
                    <div style="flex:1; color:${p.type==='pos' ? '#fff' : '#ff9999'}">${p.text}</div>
                </div>
            `).join('');
        }

        function toggleTask(i) {
            state.active.checklist[i].done = !state.active.checklist[i].done;
            renderHUDList();
            updateIntegrity();
        }

        function updateIntegrity() {
            const list = state.active.checklist;
            const pos = list.filter(p => p.type === 'pos');
            const neg = list.filter(p => p.type === 'neg');
            
            let score = 100;
            // Scoring: Start 100. If you miss positives, you lose points. If you hit negatives, you lose 15.
            if(pos.length > 0) {
                const valPerPos = 100 / pos.length;
                const missedPos = pos.filter(p => !p.done).length;
                score -= (missedPos * valPerPos);
            }
            
            const hitNeg = neg.filter(p => p.done).length;
            score -= (hitNeg * 15);
            
            score = Math.max(0, Math.round(score));
            state.active.score = score;
            
            $('hudScore').innerText = score + "% INTEGRITY";
            $('hudBar').style.width = score + "%";
            $('hudBar').style.backgroundColor = score > 80 ? colors['25'] : (score > 50 ? colors['50'] : colors['75']);
        }

        function startTimer() {
            clearInterval(state.timerId);
            updateTimerDisplay();
            state.timerId = setInterval(() => {
                state.active.timeLeft--;
                updateTimerDisplay();
                if(state.active.timeLeft <= 0) clearInterval(state.timerId);
            }, 1000);
        }

        function updateTimerDisplay() {
            const m = Math.floor(state.active.timeLeft / 60);
            const s = state.active.timeLeft % 60;
            $('hudTimer').innerText = `${m}:${s.toString().padStart(2,'0')}`;
        }

        function endMission(status) {
            clearInterval(state.timerId);
            state.history.unshift({
                name: state.active.data.name,
                score: state.active.score,
                status: status,
                time: new Date().toLocaleTimeString()
            });
            $('hud').classList.remove('active');
            state.active = null;
            saveData();
            renderLogs();
        }

        // --- LOGS ---
        function renderLogs() {
            $('logList').innerHTML = state.history.map(h => `
                <div class="log-item">
                    <div>
                        <div style="color:${varColor(h.status)}">${h.name}</div>
                        <div style="font-size:0.7rem; color:#666">${h.time}</div>
                    </div>
                    <div style="text-align:right">
                        <div class="log-score" style="color:${scoreColor(h.score)}">${h.score}%</div>
                        <div style="font-size:0.6rem; color:#666">${h.status}</div>
                    </div>
                </div>
            `).join('');
        }
        
        function varColor(s) { return s === 'COMPLETE' ? colors['25'] : colors['75']; }
        function scoreColor(s) { return s >= 80 ? colors['25'] : (s >= 50 ? colors['50'] : colors['75']); }

        // --- STORAGE ---
        function saveData() { localStorage.setItem('infOrbitV5', JSON.stringify({ dock: state.dock, history: state.history })); }
        function loadData() {
            const d = JSON.parse(localStorage.getItem('infOrbitV5'));
            if(d) { state.dock = d.dock || []; state.history = d.history || []; }
        }
        function clearLogs() { state.history = []; saveData(); renderLogs(); }

    </script>
</body>
</html>
