<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>INFINITY ORBIT v10 ‚Äî Boundary Secure</title>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Rajdhani:wght@300;400;500;600;700&family=Orbitron:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        /* --- CORE --- */
        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }
        :root {
            --gold: #c9a227; --orange: #d4740c;
            --t25: #00f0ff; --t50: #ffd700; --t75: #ff2a6d; --tinf: #d300c5;
            --glass: rgba(8, 12, 18, 0.95); --border: rgba(255, 255, 255, 0.1);
        }
        body { height: 100vh; background: #020204; font-family: 'Rajdhani', sans-serif; overflow: hidden; color: #fff; }

        /* --- BACKGROUND --- */
        .grid-bg {
            position: fixed; inset: 0; z-index: 0;
            background-image: linear-gradient(rgba(255, 255, 255, 0.04) 1px, transparent 1px), linear-gradient(90deg, rgba(255, 255, 255, 0.04) 1px, transparent 1px);
            background-size: 50px 50px;
            mask-image: radial-gradient(circle at center, black 40%, transparent 95%);
            -webkit-mask-image: radial-gradient(circle at center, black 40%, transparent 95%);
            pointer-events: none;
        }

        /* --- LAYOUT --- */
        .app { position: relative; z-index: 10; height: 100vh; display: grid; grid-template-rows: 60px 1fr; padding: 10px; gap: 10px; }
        .header { display: flex; align-items: center; justify-content: center; border-bottom: 1px solid var(--border); }
        .logo { font-family: 'Bebas Neue'; font-size: 2.5rem; letter-spacing: 5px; color: #fff; text-shadow: 0 0 15px rgba(255,255,255,0.5); }
        .workspace { display: grid; grid-template-columns: 320px 1fr 280px; gap: 15px; height: 100%; overflow: hidden; }
        @media (max-width: 1024px) { .workspace { grid-template-columns: 1fr; } .side-panel { display: none; } }

        /* --- PANELS --- */
        .panel { background: var(--glass); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border: 1px solid var(--border); border-radius: 4px; display: flex; flex-direction: column; }
        
        /* SIDE PANELS (Higher Z-Index to stay on top) */
        .side-panel { z-index: 50; position: relative; }
        
        .panel-head { padding: 15px; border-bottom: 1px solid var(--border); font-family: 'Orbitron'; font-size: 0.8rem; color: #888; letter-spacing: 2px; display: flex; align-items: center; gap: 8px; }
        .panel-dot { width: 6px; height: 6px; background: var(--gold); border-radius: 50%; box-shadow: 0 0 8px var(--gold); }
        .panel-body { padding: 15px; flex: 1; overflow-y: auto; }
        .panel.active { border-color: var(--gold); box-shadow: 0 0 25px rgba(201, 162, 39, 0.1); }

        /* --- INPUTS --- */
        .input-group { margin-bottom: 15px; }
        .label { font-family: 'Orbitron'; font-size: 0.6rem; color: #666; margin-bottom: 6px; display: block; }
        .input { width: 100%; background: rgba(0,0,0,0.5); border: 1px solid #333; color: white; padding: 10px; font-family: 'Rajdhani'; font-size: 1.1rem; outline: none; border-radius: 4px; transition: 0.3s; }
        .input:focus { border-color: var(--gold); box-shadow: 0 0 15px rgba(201, 162, 39, 0.2); }
        
        .tiers { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 20px; }
        .tier { padding: 10px 0; text-align: center; border: 1px solid #333; border-radius: 4px; cursor: pointer; background: rgba(0,0,0,0.3); transition: 0.3s; }
        .tier.active { background: rgba(0,0,0,0.8); border-width: 1px; }
        .t-name { font-family: 'Bebas Neue'; font-size: 1.2rem; }
        .t25 .t-name { color: var(--t25); } .tier.active.t25 { border-color: var(--t25); box-shadow: 0 0 15px var(--t25); }
        .t50 .t-name { color: var(--t50); } .tier.active.t50 { border-color: var(--t50); box-shadow: 0 0 15px var(--t50); }
        .t75 .t-name { color: var(--t75); } .tier.active.t75 { border-color: var(--t75); box-shadow: 0 0 15px var(--t75); }
        .tinf .t-name { color: var(--tinf); } .tier.active.tinf { border-color: var(--tinf); box-shadow: 0 0 15px var(--tinf); }

        .btn { width: 100%; padding: 14px; background: linear-gradient(90deg, var(--gold), var(--orange)); border: none; border-radius: 4px; font-family: 'Bebas Neue'; font-size: 1.3rem; letter-spacing: 2px; color: black; cursor: pointer; margin-top: 15px; transition: 0.2s; }
        .btn:hover { filter: brightness(1.2); box-shadow: 0 0 20px rgba(201, 162, 39, 0.4); }

        /* --- SPACE AREA --- */
        .space-area { position: relative; width: 100%; height: 100%; overflow: hidden; z-index: 1; }
        
        #svgLayer { position: absolute; inset: 0; width: 100%; height: 100%; pointer-events: none; z-index: 5; }
        .connection-line { fill: none; stroke: rgba(255, 255, 255, 0.2); stroke-width: 2px; stroke-dasharray: 5, 5; animation: dash 30s linear infinite; }
        .connection-line.active { stroke: #fff; stroke-opacity: 0.8; stroke-dasharray: none; filter: drop-shadow(0 0 5px #fff); }
        .connection-hitbox { fill: none; stroke: transparent; stroke-width: 15px; cursor: pointer; pointer-events: stroke; } /* Invisible Thick Line for clicking */
        @keyframes dash { to { stroke-dashoffset: -1000; } }

        /* --- ORBIT NODES --- */
        .orb-wrapper {
            position: absolute; 
            cursor: grab; z-index: 10; touch-action: none;
        }
        .orb-wrapper:active { cursor: grabbing; z-index: 40 !important; } /* Below sidebar (50) */
        
        .orb-wrapper.locked { opacity: 0.4; filter: grayscale(1); pointer-events: none; }
        .orb-wrapper.locked .orb-ctrls, .orb-wrapper.locked .resize-handle { display: none; }
        .orb-wrapper.completed .orb-core { border-style: double; border-width: 6px; }

        .orb-core {
            position: absolute; inset: 0; border-radius: 50%;
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid var(--c);
            box-shadow: 0 0 15px var(--c), inset 0 0 30px rgba(0,0,0,0.9);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            backdrop-filter: blur(5px);
            overflow: hidden;
        }

        .orb-particles {
            position: absolute; inset: -5px; border-radius: 50%;
            border: 2px dashed var(--c); opacity: 0.6;
            filter: drop-shadow(0 0 5px var(--c));
            animation: spin 30s linear infinite; pointer-events: none;
        }

        .orb-icon { font-size: 2.2em; color: #fff; margin-bottom: 2%; text-shadow: 0 0 20px var(--c); line-height: 1; }
        .orb-title { font-family: 'Rajdhani'; font-weight: 700; font-size: 0.9em; max-width: 85%; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--c); }
        .orb-time { font-family: 'Orbitron'; font-size: 0.5em; opacity: 0.8; margin-top: 2%; color: #fff; }

        @keyframes spin { to { transform: rotate(360deg); } }

        /* Controls */
        .orb-ctrls { position: absolute; top: 0; right: -30px; display: flex; flex-direction: column; gap: 5px; z-index: 20; }
        .ctrl-btn { width: 26px; height: 26px; background: #000; border: 1px solid #333; border-radius: 50%; color: #666; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; font-size: 12px; }
        .ctrl-btn:hover { transform: scale(1.15); border-color: #fff; color: #fff; }
        .c-launch { border-color: var(--c); color: var(--c); box-shadow: 0 0 10px var(--c); }
        .c-link { border-color: #fff; color: #fff; }
        .c-link.active { background: #fff; color: #000; box-shadow: 0 0 10px #fff; }
        .c-del { border-color: #ff2a6d; color: #ff2a6d; }

        /* RESIZE HANDLE */
        .resize-handle {
            position: absolute; bottom: 0; right: 0; width: 20px; height: 20px;
            cursor: nwse-resize; z-index: 30;
            background: linear-gradient(135deg, transparent 50%, rgba(255,255,255,0.5) 50%);
            border-radius: 0 0 50% 0;
            pointer-events: auto;
        }
        .resize-handle:hover { background: linear-gradient(135deg, transparent 50%, #fff 50%); }

        /* --- HUD --- */
        .hud-overlay { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.9); backdrop-filter: blur(8px); z-index: 1000; display: none; align-items: center; justify-content: center; flex-direction: column; }
        .hud-overlay.active { display: flex; }
        .hud-timer { font-family: 'Bebas Neue'; font-size: 8rem; line-height: 1; color: #fff; text-shadow: 0 0 40px var(--active-c); }
        .hud-title { font-family: 'Orbitron'; letter-spacing: 5px; color: var(--active-c); margin-bottom: 20px; font-size: 1.5rem; }
        .hud-bar-box { width: 350px; margin-bottom: 30px; }
        .bar-track { width: 100%; height: 8px; background: #222; border-radius: 4px; overflow: hidden; border: 1px solid #444; }
        .bar-fill { height: 100%; background: var(--active-c); width: 100%; transition: 0.5s; box-shadow: 0 0 20px var(--active-c); }
        .hud-tasks { width: 350px; max-height: 300px; overflow-y: auto; background: rgba(255,255,255,0.03); padding: 20px; border-radius: 8px; border: 1px solid #333; }
        .task-row { display: flex; align-items: center; gap: 15px; padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.05); cursor: pointer; }
        .task-chk { width: 20px; height: 20px; border: 2px solid #555; display: flex; align-items: center; justify-content: center; font-size: 12px; color: black; border-radius: 4px; }
        .task-row.done .task-chk { background: var(--active-c); border-color: var(--active-c); }
        .hud-actions { display: flex; gap: 20px; margin-top: 30px; }
        .hud-btn { padding: 12px 40px; background: transparent; border: 1px solid #444; color: #fff; font-family: 'Orbitron'; cursor: pointer; font-size: 0.9rem; transition: 0.3s; }
        .hud-btn:hover { background: rgba(255,255,255,0.1); border-color: #fff; }

        /* --- LOGS --- */
        .log-item { display: flex; justify-content: space-between; padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 0.9rem; }
        .log-score { font-family: 'Bebas Neue'; font-size: 1.4rem; }

        /* --- UTILS --- */
        .hidden { display: none; }
        .proc-tag { font-size: 0.6rem; padding: 2px 6px; border-radius: 2px; margin-right: 8px; color: black; font-weight: bold; }
        .tag-pos { background: var(--t25); } .tag-neg { background: var(--t75); }
        .toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: var(--gold); color: black; padding: 10px 20px; border-radius: 20px; font-family: 'Orbitron'; font-size: 0.8rem; pointer-events: none; opacity: 0; transition: 0.3s; z-index: 2000; }
        .toast.show { opacity: 1; top: 40px; }
    </style>
</head>
<body>

    <div class="grid-bg"></div>
    <div class="toast" id="toast">LINK MODE</div>

    <div class="app">
        <header class="header">
            <div class="logo">INFINITY ORBIT</div>
        </header>

        <div class="workspace">
            <div class="panel side-panel" id="editorPanel">
                <div class="panel-head"><div class="panel-dot"></div> <span id="editorTitle">MISSION COMMAND</span></div>
                <div class="panel-body">
                    <div class="tiers">
                        <div class="tier t25" onclick="setTier('25', 25)"><div class="t-name">25</div></div>
                        <div class="tier t50" onclick="setTier('50', 50)"><div class="t-name">50</div></div>
                        <div class="tier t75" onclick="setTier('75', 75)"><div class="t-name">75</div></div>
                        <div class="tier tinf" onclick="setTier('inf', 90)"><div class="t-name">‚àû</div></div>
                    </div>
                    <div class="input-group"><label class="label">CODENAME</label><input type="text" class="input" id="inpName" placeholder="e.g. Protocol Alpha"></div>
                    <div class="input-group"><label class="label">OBJECTIVE</label><input type="text" class="input" id="inpObj" placeholder="Goal..."></div>
                    <div class="input-group"><label class="label">DEADLINE</label><input type="datetime-local" class="input" id="inpDeadline" style="filter:invert(1);"></div>
                    <div style="margin-top:20px; border-top:1px solid var(--border); padding-top:10px;">
                        <div style="display:flex; justify-content:space-between; margin-bottom:10px;"><label class="label">PROTOCOLS</label><button onclick="toggleProcMode()" style="background:none; border:1px solid var(--gold); color:var(--gold); font-size:10px; padding:4px 8px; cursor:pointer;">+ ADD</button></div>
                        <div id="procInputs" class="hidden" style="display:flex; gap:5px; margin-bottom:10px;">
                            <input id="newProcTxt" class="input" style="font-size:0.8rem;" placeholder="Task...">
                            <button onclick="addProc('pos')" style="background:var(--t25); border:none; width:30px; font-weight:bold;">+</button>
                            <button onclick="addProc('neg')" style="background:var(--t75); border:none; width:30px; font-weight:bold;">-</button>
                        </div>
                        <div id="editorProcs" style="max-height:150px; overflow-y:auto;"></div>
                    </div>
                    <button class="btn" id="btnSave" onclick="saveOrbit()">INITIALIZE</button>
                    <button id="btnCancel" class="hidden" onclick="resetEditor()" style="width:100%; background:transparent; border:none; color:#666; margin-top:10px; cursor:pointer;">CANCEL</button>
                </div>
            </div>

            <div class="panel space-area" id="spaceArea">
                <svg id="svgLayer"><defs><marker id="arrow" markerWidth="10" markerHeight="10" refX="20" refY="3" orient="auto" markerUnits="strokeWidth"><path d="M0,0 L0,6 L9,3 z" fill="rgba(255,255,255,0.4)" /></marker></defs></svg>
                <div id="orbContainer"></div>
                <div style="position:absolute; bottom:15px; left:50%; transform:translateX(-50%); font-family:'Orbitron'; font-size:0.7rem; color:rgba(255,255,255,0.3); pointer-events:none;">SYSTEM READY</div>
            </div>

            <div class="panel side-panel">
                <div class="panel-head"><div class="panel-dot"></div> FLIGHT LOGS</div>
                <div class="panel-body" id="logList"></div>
                <div style="display:flex; gap:5px;">
                    <button onclick="resetProgress()" style="flex:1; background:transparent; border:1px solid var(--gold); color:var(--gold); font-size:0.6rem; padding:10px; cursor:pointer; margin-top:10px;">RESET PROGRESS</button>
                    <button onclick="clearLogs()" style="flex:1; background:transparent; border:1px solid #444; color:#444; font-size:0.6rem; padding:10px; cursor:pointer; margin-top:10px;">PURGE LOGS</button>
                </div>
            </div>
        </div>
    </div>

    <div class="hud-overlay" id="hud">
        <div class="hud-title" id="hudName">MISSION ACTIVE</div>
        <div class="hud-timer" id="hudTimer">00:00</div>
        <div class="hud-bar-box">
            <div class="bar-track"><div class="bar-fill" id="hudBar"></div></div>
            <div style="display:flex; justify-content:space-between; font-family:'Orbitron'; font-size:0.7rem; margin-top:5px; color:#888;"><span>INTEGRITY</span><span id="hudScore" style="color:#fff">100%</span></div>
        </div>
        <div class="hud-tasks" id="hudList"></div>
        <div class="hud-actions">
            <button class="hud-btn" onclick="endMission('ABORTED')" style="border-color:var(--t75); color:var(--t75)">ABORT</button>
            <button class="hud-btn" onclick="endMission('COMPLETE')" style="border-color:var(--t25); color:var(--t25); box-shadow:0 0 15px rgba(0,240,255,0.2)">COMPLETE</button>
        </div>
    </div>

    <script>
        const colors = { '25': '#00f0ff', '50': '#ffd700', '75': '#ff2a6d', 'inf': '#d300c5' };
        const state = { dock: [], links: [], history: [], editor: { editing: false, id: null, tier: null, duration: 0, procs: [] }, active: null, timerId: null, linking: null };
        const $ = (id) => document.getElementById(id);
        
        window.onload = () => { loadData(); renderSpace(); renderLogs(); animateLinks(); };

        // EDITOR
        function setTier(t, d) { state.editor.tier = t; state.editor.duration = d; document.querySelectorAll('.tier').forEach(el => el.classList.remove('active')); document.querySelector(`.t${t}`).classList.add('active'); }
        function toggleProcMode() { $('procInputs').classList.toggle('hidden'); $('newProcTxt').focus(); }
        function addProc(type) { const txt = $('newProcTxt').value.trim(); if(!txt)return; state.editor.procs.push({ text: txt, type: type }); $('newProcTxt').value = ''; renderEditorProcs(); }
        function renderEditorProcs() { $('editorProcs').innerHTML = state.editor.procs.map((p, i) => `<div style="display:flex; justify-content:space-between; padding:8px; border-bottom:1px solid rgba(255,255,255,0.05); font-size:0.9rem;"><div><span class="proc-tag ${p.type==='pos'?'tag-pos':'tag-neg'}">${p.type==='pos'?'+':'-'}</span> ${p.text}</div><div style="cursor:pointer; color:#666;" onclick="delProc(${i})">√ó</div></div>`).join(''); }
        function delProc(i) { state.editor.procs.splice(i, 1); renderEditorProcs(); }
        function saveOrbit() {
            const name = $('inpName').value.trim(); if (!name || !state.editor.tier) return alert("Name and Tier required");
            const data = {
                id: state.editor.editing ? state.editor.id : Date.now(),
                name: name, obj: $('inpObj').value || 'No Objective', deadline: $('inpDeadline').value,
                tier: state.editor.tier, duration: state.editor.duration, procs: [...state.editor.procs],
                x: state.editor.editing ? getOrbit(state.editor.id).x : 50,
                y: state.editor.editing ? getOrbit(state.editor.id).y : 50,
                size: state.editor.editing ? (getOrbit(state.editor.id).size || 140) : 140,
                completed: state.editor.editing ? getOrbit(state.editor.id).completed : false
            };
            if (state.editor.editing) { state.dock[state.dock.findIndex(o => o.id === data.id)] = data; } else { state.dock.push(data); }
            saveData(); renderSpace(); resetEditor();
        }
        function editOrbit(id) {
            const o = getOrbit(id); state.editor = { editing: true, id: id, tier: o.tier, duration: o.duration, procs: [...o.procs] };
            $('inpName').value = o.name; $('inpObj').value = o.obj; $('inpDeadline').value = o.deadline; setTier(o.tier, o.duration); renderEditorProcs();
            $('editorTitle').innerText = "EDITING SIGNAL"; $('btnSave').innerText = "UPDATE ORBIT"; $('editorPanel').classList.add('active'); $('btnCancel').classList.remove('hidden');
        }
        function resetEditor() { state.editor = { editing: false, id: null, tier: null, duration: 0, procs: [] }; $('inpName').value = ''; $('inpObj').value = ''; $('inpDeadline').value = ''; $('editorProcs').innerHTML = ''; document.querySelectorAll('.tier').forEach(el => el.classList.remove('active')); $('editorTitle').innerText = "MISSION COMMAND"; $('btnSave').innerText = "INITIALIZE"; $('editorPanel').classList.remove('active'); $('btnCancel').classList.add('hidden'); }

        // SPACE
        function renderSpace() {
            $('orbContainer').innerHTML = state.dock.map(o => {
                const color = colors[o.tier]; const isLocked = checkLocked(o.id);
                const size = o.size || 140; 
                const fontSize = Math.max(8, size / 9); 
                const linkActive = state.linking === o.id;

                return `
                <div class="orb-wrapper ${isLocked?'locked':''} ${o.completed?'completed':''}" id="orb-${o.id}" 
                     style="left:${o.x}px; top:${o.y}px; width:${size}px; height:${size}px; font-size:${fontSize}px;" 
                     onmousedown="startDrag(event, ${o.id})" ontouchstart="startDrag(event, ${o.id})">
                    
                    <div class="orb-ctrls">
                        <div class="ctrl-btn c-launch" onmousedown="event.stopPropagation()" ontouchstart="event.stopPropagation()" onclick="launchMission(${o.id})">üöÄ</div>
                        <div class="ctrl-btn c-link ${linkActive?'active':''}" onmousedown="event.stopPropagation()" ontouchstart="event.stopPropagation()" onclick="startLink(${o.id})">üîó</div>
                        <div class="ctrl-btn" onmousedown="event.stopPropagation()" ontouchstart="event.stopPropagation()" onclick="editOrbit(${o.id})">‚úé</div>
                        <div class="ctrl-btn c-del" onmousedown="event.stopPropagation()" ontouchstart="event.stopPropagation()" onclick="deleteOrbit(${o.id})">√ó</div>
                    </div>

                    <div class="orb-core" style="--c:${color}" onclick="completeLink(${o.id})">
                        <div class="orb-particles" style="--c:${color}"></div>
                        <div class="orb-icon">‚óè</div>
                        <div class="orb-title" style="--c:${color}">${o.name}</div>
                        <div class="orb-time">${o.duration} MIN</div>
                    </div>
                    
                    <div class="resize-handle" onmousedown="startResize(event, ${o.id})" ontouchstart="startResize(event, ${o.id})"></div>
                </div>`;
            }).join('');
            renderLinks();
        }
        function checkLocked(id) { const inc = state.links.filter(l => l.target === id); if(inc.length===0) return false; return inc.some(l => !getOrbit(l.source).completed); }

        // RESIZING
        let resizing = { active: false, id: null, startX: 0, startWidth: 0 };
        function startResize(e, id) {
            e.stopPropagation(); e.preventDefault();
            const el = $(`orb-${id}`);
            const cX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
            resizing = { active: true, id: id, startX: cX, startWidth: el.offsetWidth };
        }
        function doResize(e) {
            if(!resizing.active) return;
            const cX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
            const diff = cX - resizing.startX;
            const newSize = Math.max(70, resizing.startWidth + diff); 
            const el = $(`orb-${resizing.id}`);
            el.style.width = newSize + 'px'; el.style.height = newSize + 'px';
            const newFS = Math.max(8, newSize / 9); el.style.fontSize = newFS + 'px';
        }
        function endResize() {
            if(!resizing.active) return;
            const o = getOrbit(resizing.id); const el = $(`orb-${resizing.id}`);
            o.size = parseInt(el.style.width); saveData(); resizing.active = false;
        }

        // DRAGGING
        let drag = { active: false, id: null, offX: 0, offY: 0 };
        function startDrag(e, id) {
            if (e.target.closest('.orb-ctrls') || e.target.classList.contains('resize-handle')) return;
            const el = $(`orb-${id}`);
            const cX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
            const cY = e.type.includes('touch') ? e.touches[0].clientY : e.clientY;
            drag = { active: true, id: id, offX: cX - el.offsetLeft, offY: cY - el.offsetTop };
            el.style.zIndex = 1000;
        }
        function doDrag(e) {
            if (resizing.active) { doResize(e); return; }
            if (!drag.active) return;
            e.preventDefault();
            const cX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
            const cY = e.type.includes('touch') ? e.touches[0].clientY : e.clientY;
            
            // BOUNDARY LOGIC
            const rect = $('spaceArea').getBoundingClientRect();
            const orbitW = getOrbit(drag.id).size || 140;
            const margin = 20;

            let x = cX - drag.offX;
            let y = cY - drag.offY;

            // Strict Clamping
            x = Math.max(margin, Math.min(x, rect.width - orbitW - margin));
            y = Math.max(margin, Math.min(y, rect.height - orbitW - margin));

            const el = $(`orb-${drag.id}`);
            el.style.left = x + 'px'; el.style.top = y + 'px';
        }
        function endDrag() {
            if (resizing.active) { endResize(); return; }
            if (!drag.active) return;
            const o = getOrbit(drag.id); const el = $(`orb-${drag.id}`);
            o.x = parseInt(el.style.left); o.y = parseInt(el.style.top);
            el.style.zIndex = 10; drag.active = false; saveData();
        }

        window.addEventListener('mousemove', doDrag); window.addEventListener('touchmove', doDrag, {passive: false});
        window.addEventListener('mouseup', endDrag); window.addEventListener('touchend', endDrag);

        // LINKS
        function startLink(id) { 
            state.linking = id; 
            $('toast').innerText = "SELECT TARGET ORBIT";
            $('toast').classList.add('show'); 
            renderSpace(); // Update UI for active link button
        }
        
        function completeLink(targetId) {
            if(state.linking) {
                if(state.linking === targetId) { 
                    alert("Cannot link to self"); 
                } else {
                    // CHECK IF LINK EXISTS
                    const existingIdx = state.links.findIndex(l => 
                        (l.source === state.linking && l.target === targetId)
                    );

                    if (existingIdx >= 0) {
                        // REMOVE
                        state.links.splice(existingIdx, 1);
                        $('toast').innerText = "CONNECTION SEVERED";
                    } else {
                        // ADD
                        state.links.push({ source: state.linking, target: targetId });
                        $('toast').innerText = "ORBITS LINKED";
                    }
                    saveData(); 
                    renderSpace();
                    
                    // Hide toast after delay
                    setTimeout(() => $('toast').classList.remove('show'), 2000);
                }
                state.linking = null; 
            }
        }

        function renderLinks() {
            const svg = $('svgLayer');
            // Remove old lines only, keep marker
            Array.from(svg.children).forEach(c => { if(c.tagName==='line' || c.tagName==='path') svg.removeChild(c) });

            state.links.forEach(l => {
                const s = getOrbit(l.source); const t = getOrbit(l.target);
                if(s && t) {
                    const sSize = s.size || 140; const tSize = t.size || 140;
                    
                    // Visual Line
                    const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    line.setAttribute('x1', s.x + (sSize/2)); line.setAttribute('y1', s.y + (sSize/2));
                    line.setAttribute('x2', t.x + (tSize/2)); line.setAttribute('y2', t.y + (tSize/2));
                    line.setAttribute('class', `connection-line ${s.completed?'active':''}`);
                    line.setAttribute('marker-end', 'url(#arrow)');
                    svg.appendChild(line);

                    // Hitbox (Thicker invisible line for double-click delete)
                    const hit = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    hit.setAttribute('x1', s.x + (sSize/2)); hit.setAttribute('y1', s.y + (sSize/2));
                    hit.setAttribute('x2', t.x + (tSize/2)); hit.setAttribute('y2', t.y + (tSize/2));
                    hit.setAttribute('class', 'connection-hitbox');
                    hit.ondblclick = () => deleteLink(l);
                    svg.appendChild(hit);
                }
            });
        }
        function deleteLink(lObj) { if(confirm("Remove connection?")) { state.links.splice(state.links.indexOf(lObj), 1); saveData(); renderSpace(); } }
        function animateLinks() { renderLinks(); requestAnimationFrame(animateLinks); }

        function deleteOrbit(id) { if(confirm("Delete orbit?")) { state.dock = state.dock.filter(o => o.id !== id); state.links = state.links.filter(l => l.source !== id && l.target !== id); saveData(); renderSpace(); } }
        function getOrbit(id) { return state.dock.find(o => o.id === id); }

        // MISSION
        function launchMission(id) {
            const o = getOrbit(id); if(checkLocked(id)) { alert("LOCKED"); return; }
            state.active = { data: o, timeLeft: o.duration * 60, checklist: o.procs.map(p => ({...p, done: false})) };
            $('hudName').innerText = o.name.toUpperCase(); document.documentElement.style.setProperty('--active-c', colors[o.tier]); $('hud').classList.add('active'); renderHUDList(); updateIntegrity(); startTimer();
        }
        function renderHUDList() { $('hudList').innerHTML = state.active.checklist.map((p, i) => `<div class="task-row ${p.done?'done':''} ${p.type}" onclick="toggleTask(${i})"><div class="task-chk">${p.done?'‚úì':''}</div><div style="flex:1; color:${p.type==='pos'?'#fff':'#ff9999'}">${p.text}</div></div>`).join(''); }
        function toggleTask(i) { state.active.checklist[i].done = !state.active.checklist[i].done; renderHUDList(); updateIntegrity(); }
        function updateIntegrity() {
            const list = state.active.checklist; const pos = list.filter(p => p.type === 'pos'); const neg = list.filter(p => p.type === 'neg');
            let score = 100;
            if(pos.length > 0) score -= (pos.filter(p => !p.done).length * (100/pos.length));
            score -= (neg.filter(p => p.done).length * 15);
            score = Math.max(0, Math.round(score)); state.active.score = score;
            $('hudScore').innerText = score + "%"; $('hudBar').style.width = score + "%";
        }
        function startTimer() { clearInterval(state.timerId); updateTimerDisplay(); state.timerId = setInterval(() => { state.active.timeLeft--; updateTimerDisplay(); if(state.active.timeLeft <= 0) clearInterval(state.timerId); }, 1000); }
        function updateTimerDisplay() { const m = Math.floor(state.active.timeLeft / 60); const s = state.active.timeLeft % 60; $('hudTimer').innerText = `${m}:${s.toString().padStart(2,'0')}`; }
        function endMission(status) {
            clearInterval(state.timerId); if(status === 'COMPLETE') { getOrbit(state.active.data.id).completed = true; }
            state.history.unshift({ name: state.active.data.name, score: state.active.score, status: status, time: new Date().toLocaleTimeString(), color: colors[state.active.data.tier] });
            $('hud').classList.remove('active'); state.active = null; saveData(); renderSpace(); renderLogs();
        }

        // UTILS
        function resetProgress() { if(confirm("Reset day?")) { state.dock.forEach(o => o.completed = false); saveData(); renderSpace(); } }
        function renderLogs() { $('logList').innerHTML = state.history.map(h => `<div class="log-item"><div><div style="color:${h.color}">${h.name}</div><div style="font-size:0.7rem; color:#666">${h.time}</div></div><div style="text-align:right"><div class="log-score" style="color:${h.color}">${h.score}%</div><div style="font-size:0.6rem; color:#666">${h.status}</div></div></div>`).join(''); }
        function saveData() { localStorage.setItem('infOrbitV10', JSON.stringify({ dock: state.dock, links: state.links, history: state.history })); }
        function loadData() { const d = JSON.parse(localStorage.getItem('infOrbitV10')); if(d) { state.dock = d.dock || []; state.links = d.links || []; state.history = d.history || []; } }
        function clearLogs() { state.history = []; saveData(); renderLogs(); }
    </script>
</body>
</html>
